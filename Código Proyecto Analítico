# ------------------------------------
# PROYECTO ANALÍTICO en RStudio.
# ------------------------------------

#     Cargar librerías

# 0.- Acceder a la API de twitter
# 1.- Descargar el conjunto de datos
# 2.- Limpieza de los datos
# 3.- Análisis de los datos
# 4.- Representación de los resultados


#   Cargar librerías
# ------------------------------------

# Funciones recursivas, paquete twitter en R, manejo cadena caractéres.
# biblioteca de gráficos interactivos.
library(plyr)
library(twitteR)
library(stringr)
library(highcharter)


# 0.- Acceder a la API de twitter
# ------------------------------------

# Cargar fichero externo conteniendo parámetros de acceso a twitter:
# consumer_key, consumer_secret, access_token y access_secret.
source("twitter-auth.R")

# Acceder y conectarse a la API de twitter.
setup_twitter_oauth(Consumer_key, Consumer_secret, Access_token, Access_secret)


# 1.- Descargar el conjunto de datos
# ------------------------------------

# Número de tweets a descargar
num.tweets <- 1000

# Descargar la lista de tweets del tema de interés.
tweets <- searchTwitter("#Feminismo", n=num.tweets, lang = "es")

# Pasar la lista a data.frame y visualizarla
tweetsDF <- twListToDF(tweets)
View(tweetsDF)

# Ver la totalidad de las variables
names(tweetsDF)

# Exportar data.frame 1 ORIGINAL a un archivo .csv
write.csv(tweetsDF, file="1-ORIGINAL-tweetsDF.csv")


# 2.- Limpieza de los datos
# ------------------------------------

# FUNCIÓN limpiar tweets
limpiarTweets = function(tweets)
{
  tweets_lm = gsub("(RT|via)((?:\\b\\W*@\\w+)+)","",tweets)
  tweets_lm = gsub("http[^[:blank:]]+", "", tweets_lm)
  tweets_lm = gsub("@\\w+", "", tweets_lm)
  tweets_lm = gsub("[ \t]{2,}", "", tweets_lm)
  tweets_lm = gsub("^\\s+|\\s+$", "", tweets_lm)
  tweets_lm = gsub("[[:punct:]]", " ", tweets_lm)
  tweets_lm = gsub("[^[:alnum:]]", " ", tweets_lm)
  tweets_lm <- gsub('\\d+', '', tweets_lm)
  return(tweets_lm)
}

# Del total de variables del tweet, extraemos solo el campo $text.
tweets_txt=sapply(tweets[1:num.tweets], function(x) x$getText())

# Ejecutar función limpiar tweets.
tweets_txt <- limpiarTweets(tweets_txt)



# 3.- Análisis de los datos
# ------------------------------------

# FUNCIÓN para clasificar palabras del texto del tweet, en 4 categorias: 
  # mNeg <- muyNegativo, neg <- negativo, pos <- positivo y mPos <- muyPositivo.
sentimientosScore <- function(frases, mNeg, neg, pos, mPos){
 
 # Inicializar.
  scores_final <- matrix('', 0, 5)
 
  # Devuelve una lista.
  scores <- laply(frases, function(frase, mNeg, neg, pos, mPos){
    frase_inicial <- frase
   
    # Limpieza de los datos eliminando los caracteres innecesarios.
    frase <- tolower(frase)
    listaPalabras <- str_split(frase, '\\s+')
    palabras <- unlist(listaPalabras)
   
    # Construye un vector con los emparejamientos (frase versus categorias)
    mPosMatches <- match(palabras, mPos)
    posMatches <- match(palabras, pos)
    mNegMatches <- match(palabras, mNeg)
    negMatches <- match(palabras, neg)
   
    # Suma las palabras por categorias
    mPosMatches <- sum(!is.na(mPosMatches))
    posMatches <- sum(!is.na(posMatches))
    mNegMatches <- sum(!is.na(mNegMatches))
    negMatches <- sum(!is.na(negMatches))
    score <- c(mNegMatches, negMatches, posMatches, mPosMatches)
   
    # Incorpora los resultados agregando una linea a la tabla de puntuaciones
    nlinea <- c(frase_inicial, score)
    scores_final <- rbind(scores_final, nlinea)
    return(scores_final)
    
  }, mNeg, neg, pos, mPos)
    return(scores)
}

# Cargar la lista de palabras valor. 
words_list <- read.csv(file='LISTA-Palabras-Sentimientos.txt', header=FALSE, stringsAsFactors=T)
names(words_list) <- c('palabra', 'score')
words_list$palabra <- tolower(words_list$palabra)

# categorizar las palabras en 4 categorías (de muy negativas a muy positivas).
mNeg <- words_list$palabra[words_list$score==-5 | words_list$score==-4]
neg <- c(words_list$palabra[words_list$score==-3 | words_list$score==-2 | words_list$score==-1])
pos <- c(words_list$palabra[words_list$score==3 | words_list$score==2 | words_list$score==1])
mPos <- c(words_list$palabra[words_list$score==5 | words_list$score==4])  

# Calcular la puntuación de cada tweet
tweetResultado <- as.data.frame(sentimientosScore(tweets_txt, mNeg, neg, pos, mPos))

# Agregar dos nuevas columnas inicializadas.
tweetResultado <- cbind(tweetResultado,0,'Neutro')

# Dar normbre a las variables
names(tweetResultado)<- c('texto',"muyNeg",'Neg','muyPos','Pos','Valor', 'Sentimiento')

# Pasar a caracter y ponderar
tweetResultado$Sentimiento <- as.character(tweetResultado$Sentimiento)
tweetResultado$Valor <- (-5*as.numeric(tweetResultado$muyNeg) -2.5*as.numeric(tweetResultado$Neg) + 2.5*as.numeric(tweetResultado$Pos) +5*as.numeric(tweetResultado$muyPos))/(as.numeric(tweetResultado$muyNeg)+as.numeric(tweetResultado$Neg)+as.numeric(tweetResultado$muyPos)+as.numeric(tweetResultado$Pos))
tweetResultado$Valor[is.nan(tweetResultado$Valor)] <- 0

# Categorizar resultados en 4 categorías (de muy negativo a muy positivo).
tweetResultado$Sentimiento[tweetResultado$Valor < -1] <- 'Muy Negativo'
tweetResultado$Sentimiento[(tweetResultado$Valor >= -1) & (tweetResultado$Valor < 0)] <- 'Negativo'
tweetResultado$Sentimiento[(tweetResultado$Valor <= 1) & (tweetResultado$Valor > 0)] <- 'Positivo'
tweetResultado$Sentimiento[tweetResultado$Valor > 1] <- 'Muy Positivo'

# Exportar data.frame tweetResultado, a un archivo .csv
write.csv(tweetResultado, file="2-tweet.Resultado.csv")



# 4.- Representación de los resultados
# ------------------------------------

# Creamos una tabla de frecuencias: 4 sentimientos y neutro.
conteo <- as.data.frame(table(tweetResultado$Sentimiento))

# Exportar la tabla de frecuencias (conteo): 4 sentimientos y neutro CONTEO, a un archivo .csv
write.csv(conteo, file="3-Tabla-Conteo-Sentimientos.csv")

# Representamos la tabla de frecuencias: 4 sentimientos y neutro.
plot(table(tweetResultado$Sentimiento))

# Exportar Rplot a un archivo .png
png("3.2-Rplot.Sentimientos.png")

# Representación de las valoraciones por sectores.
colores = c("red","green", "orange", "lightyellow","lightgreen")
pie(conteo$Freq, conteo$Var1, col = colores)

dev.off()

# Gráfico por sectores con "highchart" file: 3-Rplot.Sentimientos.Feminismo
sentimientos <- data.frame(nombre = c('Muy Negativo','Muy Positivo', 'Negativo', 'Neutro', 'Positivo'),
                           Freq = c(conteo$Freq))

hc_pie <- highchart(width = 600, height = 600) %>%
  hc_title(text = "Distribución de Sentimientos - #Feminismo (1000 tweets)") %>%
  hc_chart(type = "pie", options3d = list(enabled = TRUE, alpha = 35, beta =0)) %>%
  hc_plotOptions(pie = list(depth = 55)) %>%
  hc_add_series_labels_values(sentimientos$nombre, sentimientos$Freq)

hc_pie




